
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="../Libs/jquery-ui-1.11.4/jquery-ui.css" rel="stylesheet">
<link rel="stylesheet" href="../Libs/bootstrap/css/bootstrap.min.css">
<script src="../Libs/jquery/jquery-1.12.3.min.js"></script>
<script src="../Libs/bootstrap/js/bootstrap.min.js"></script>
<script src="../Libs/jquery-ui-1.11.4/jquery-ui.js"></script>

<script src="../Libs/expression.js"></script>
<script src="../Libs/math.min.js"></script>


<script src="../Libs/jquery.tabletoCSV.js" type="text/javascript" charset="utf-8"></script>
 <link rel="stylesheet"  href="../globarCss.css">
<style type="text/css">
  tr {
    width: 100%;
    display: inline-table;
    table-layout: fixed;
    overflow: hidden;
  }

  table{
   height:300px; 
   table-layout: fixed;
   overflow-y: scroll;
   width: 80px;
   /*border: 1px solid black;*/
 }
 tbody{
  overflow-y: scroll;
  height: 450px;
  /*width: 100%;*/
  position: absolute;
}
td, th {
 border: 1px solid black;
 width: 80px;
 text-align: center;
 word-wrap:break-word;
 position: static;
outline: 0;
}
th {
  color: red;
  background-color: #b3b3b3;
}

.highlight {
  background: #f4e092;
}
.colorButton {
  background-color: #938b8c;
  height:30px;
  width:100px;
  margin-left: 20px
}


</style>
<div class="row content" style=" width:1000px">
  <div class="col-sm-9 ">
    <p id=showTable ></p>
  </div>
  <div class="col-sm-3">
    <br>
    <button id="addColumnButton" value="Open Dialog" class="btn btn-success colorButton"  >Add Column</button><br><br>
    <button class="btn btn-success colorButton"  onclick="deleteConfirmFunction()">Delete</button><br><br><br><br>
    <button id ="btnExport" class="btn btn-success colorButton" >Export</button>
  </div>
</div>
<div id="dialog">
  <form>
    <p>
      <label for="nameOfNewColumn">Name:</label>
      <input id="nameOfNewColumn" type="text">
    </p>
    <p>
      <label> Equalition:</label><br>
      <textarea id="ColumnEqualition" rows="2" cols="60" placeholder="Enter equalition"></textarea>
    </p>
    <label> Description:</label><br>
    <textarea id="ColumnDescription" rows="2" cols="60" placeholder="Enter description"></textarea>
    <br><label> Note:
    <pre>
      - dis(x): Derivative of x
      - inf(x): Integral of x
      - const(A): Constant name A, 
      which can be changed while drawing
      - operation: + (add), -(sub), *(mul), / (div)
    </pre>
  </label>
</form>
</div>
<script type="text/javascript">
  //Export to EXCEL
  $(function(){
      $("#btnExport").click(function(){
          $("#dataTableID").tableToCSV();
      });
  });
  
  $("#dialog").dialog({
    autoOpen: false,
    width: 500,
    height: 450,
    // modal: true,
    title: "Add Column",
    dialogClass: "dlg-no-close",
    position: {
      my: "right",
      at: "center"
    },
    buttons: { 
      Ok: function() {
        addNewColumn();
        $(this).dialog("close");
      },
      Cancel: function () {
        $(this).dialog("close");
      }
    }
  });

  var selectCoulumnIndex = -1;
  function setIndexAndHighlight (){
    $('#dataTableID th').each(function(index) {
      $(this).click(function() {
        selectCoulumnIndex = index;
        if(index > 0){
          parent.columnSelected = selectCoulumnIndex -1;
          window.parent.reloadInfoColumn();
        }
        console.log(index);
        $('tr').each(function() {
          if(index > 0){
            $(this).find('td').not(':eq(index)').removeClass('highlight');
            $(this).find('th').not(':eq(index)').removeClass('highlight');
            $(this).find('td').eq(index).toggleClass('highlight');
            $(this).find('th').eq(index).toggleClass('highlight');
          }
        });
      });
    });
  }
  $(document).ready(function() {
    setIndexAndHighlight();
  });

  $("#addColumnButton").click(function () {
    $("#dialog").dialog("open");
  });

  function deleteConfirmFunction() {
    if(selectCoulumnIndex > 0)
    {
      var r = confirm("Are you sure you want to delete " + parent.tableLable[selectCoulumnIndex - 1] + " column? The relative graph will be deleted");
      if (r == true) {
        deleteSelectColumn(selectCoulumnIndex);
        selectCoulumnIndex = -1;
      } else {
        txt = "You pressed Cancel!";
      }
    }
  }

	function addNewColumn (){
		listOfSymbol = {}
		listOfConst = {}
    LENGHT = parent.totalValueRow
		parent.tableLable.forEach(function myFunction(item, index) {
			listOfSymbol[item.replace(/\s/g, '')] = parent.matrix[index]
		})
    listOfSymbol['time'] = parent.recordId;


		try{
			var ex = formatExpression(ColumnEqualition.value)
			console.log(ex)
			console.log(listOfConst)
			newColumnValues = compute(ex)
			console.log(newColumnValues)

			parent.tableLable.push(nameOfNewColumn.value);
			var selectRow;
			var newTH = document.createElement('th');
			selectRow = document.getElementById("dataTableID").rows[0];
			selectRow.appendChild(newTH);
			newTH.innerHTML = parent.tableLable[parent.tableLable.length-1];
			
			for(var i = 1; i <= parent.totalValueRow; i++)
			{
				selectRow = document.getElementById("dataTableID").rows[i];
				selectRow.insertCell(parent.tableLable.length).innerHTML =newColumnValues[i - 1];
			}
      
		    parent.matrix.push(newColumnValues);
		    parent.totalSensorAvailable++;
		    console.log(parent.columnInfo);
		    parent.columnInfo.push({
				Name: nameOfNewColumn.value,
				Type: "newColumn",
				Average: getAverage(newColumnValues),
				Max: getMax(newColumnValues),
				Min: getMin(newColumnValues),
        		Delta: getdelta(newColumnValues),
				Description: ColumnDescription.value,
				Equalition: ColumnEqualition.value,
				ConstantArray: listOfConst,
		    });
		    setIndexAndHighlight();
		}
		catch(e){
			console.log(e)
			alert("Syntax error : " + e.message);
		}
	}



  function deleteSelectColumn (index){
    var indexOfTable = index -1;
    parent.tableLable.splice(indexOfTable, 1);
    parent.columnInfo.splice(indexOfTable, 1);
    parent.matrix.splice(indexOfTable,1);
    var selectRow;
    for(var i = 0; i <= parent.totalValueRow; i++)
    {
      selectRow = document.getElementById("dataTableID").rows[i];
      selectRow.deleteCell(index);
    }
    parent.totalSensorAvailable--;
    setIndexAndHighlight();
    parent.GraphInfo.forEach( function (item, index1){
      if(item!=0)
      {
        if(item.X == indexOfTable){
          parent.removeTabWithTabID(index1);
        }
        else if(item.X > indexOfTable)
        { 
          item.X --;
        }
        if(item.Y1 == indexOfTable){
          parent.removeTabWithTabID(index1);
        }
        else if(item.Y1 > indexOfTable)
        { 
          item.Y1 --;
        }
        if(item.Y2 == indexOfTable){
          parent.removeTabWithTabID(index1);
        }
        else if(item.Y2 > indexOfTable)
        { 
          item.Y2 --;
        }
        if(item.Y3 == indexOfTable){
          parent.removeTabWithTabID(index1);
        }
        else if(item.Y3 > indexOfTable)
        { 
          item.Y3 --;
        }
      }
    });
  }

  function getAverage(array)
  {
    var total = 0;
    array.forEach( function (item, index){
      total+=item;
    });
    return total/array.length;
  }

  function getdelta(array)
  {
    var Average = getAverage(array);
    var total = 0;
    array.forEach( function (item, index){
      total+=Math.abs(item -Average) ;
    });
    return total/array.length;
  }

  function getMax(array)
  {
    var max = array[0];
    array.forEach( function (item, index){
      if(max <item)
        max=item;
    });
    return max;
  }
  function getMin(array)
  {
    var min = array[0];
    array.forEach( function (item, index){
      if(min > item)
        min=item;
    });
    return min;
  }
// load data from global variable
var myTable= "<table  id =\"dataTableID\" class=\"table table-hover\"><tr><th style='color: red;'>Time</th>";
for (var i=0; i<parent.totalSensorAvailable; i++) {
  parent.tableLable[i] = parent.sensorInfo[i].sensorName;
  myTable+= "<th style='color: red;'>" + parent.tableLable[i] +"</th>";
} 
myTable +="</tr>";

for (var j=0; j<parent.totalValueRow; j++) {
  myTable+="<tr id=\""+parent.recordId[j] +"\">";
  myTable+="<td>" +parent.recordId[j] + "</td>";
  for (i=0; i<parent.totalSensorAvailable; i++) {
    myTable+="<td>" + parent.matrix[i][j] + "</td>";
  }
  myTable+="</tr>";
}  
myTable+="</table>";
document.getElementById("showTable").innerHTML = myTable;
// reset value of column Info when F5.
parent.columnInfo =[];
for (var i=0; i<parent.totalSensorAvailable; i++) {
  parent.columnInfo.push({
    Name: parent.sensorInfo[i].sensorName,
    Type: parent.sensorInfo[i].sensorType,
    Average: getAverage(parent.matrix[i]),
    Max: getMax(parent.matrix[i]),
    Min: getMin(parent.matrix[i]),
    Delta: getdelta(parent.matrix[i]),
    Description: parent.sensorInfo[i].sensorDescription,
    Equalition: "",
    ConstantArray: {},
  });
}
</script>